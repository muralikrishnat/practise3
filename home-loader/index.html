<html>

<head>
    <title>Canvas Image Editor</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0, maximum-scale=1, minimum-scale=1">
    <link rel="stylesheet" type="text/css" href="styles.css" />
</head>

<body>
    <div>
        <input onchange="handleImage(event)" type="file" class="ptn-abs gallery" accept="image/*">
    </div>
    <div class="photo-holder">

    </div>

    <script>
        var $ = function (selector) {
            return document.querySelector(selector);
        };

        var getNewElement = function (elemName) {
            return document.createElement(elemName);
        };

        var setStyles = function (elem, styles) {
            Object.keys(styles).forEach(function (key) {
                elem.style[key] = styles[key];
            });
        };
    </script>
    <script>
        var renderPoint = function (elem) {
            var point = getNewElement('DIV');
            setStyles(point, {
                width: 30,
                height: 30,
                backgroundColor: '#f1f1f1',
                position: 'absolute',
                left: 100,
                top: 100,
                borderRadius: '25px',
                border: '4px solid black'
            });
            point.addEventListener('touchmove', function (evt) {
                if (evt.touches.length === 1) {
                    var rect = elem.getBoundingClientRect();
                    var mX = evt.touches[0].clientX,
                        mY = evt.touches[0].clientY;
                    setStyles(point, {
                        left: mX - rect.left - 15,
                        top: mY - rect.top - 15
                    });
                }
                if (evt.preventDefault) {
                    evt.preventDefault();
                }
                if (evt.stopPropagation) {
                    evt.stopPropagation();
                }
            }, false);
            elem.append(point);
        };

        var createSVG = function (w, h) {
            // var svg = document.createElement('SVG');
            // svg.setAttribute('width', w);
            // svg.setAttribute('height', h);
            // //svg.innerHTML = '<path d="M150 0 L75 200 L225 200 Z" />Sorry, your browser does not support inline SVG.';
            // var path = document.createElement('PATH');
            // $('.photo-holder').append(svg);


            var $div = getNewElement('DIV');
            $div.classList = 'canvas-mask'
            $div.style.width = w;
            $div.style.height = h;
            $div.style.backgroundColor = 'red';

            setStyles($div, {
                width: w,
                height: h,
                backgroundColor: 'transparent',
                position: 'absolute',
                top: 0,
                left: 0
            });

            $div.addEventListener('touchstart', function (evt) {
                if (evt.touches.length === 1) {
                    console.log('holder : ', evt.touches[0].clientX, evt.touches[0].clientY);
                }
            }, false);
            renderPoint($div);

            $('.photo-holder').append($div);
        };
    </script>
    <script>
        var canvasConfig = {
            imgSrc: null,
            doors: [],
            canvasDimensions: {
                width: 100,
                height: 100
            },
            canvasCtx: null
        };

        var setLoader = function (isRemove) {
            if (isRemove) {
                if ($('.loader')) {
                    $('.loader').remove();
                }
            } else {
                var loaderElem = document.createElement('DIV');
                loaderElem.classList = 'loader';
                $('body').append(loaderElem);
            }
        };

        function getMousePos(canvas, evt) {
            var rect = canvas.getBoundingClientRect();
            let x = 0,
                y = 0;
            if (evt.touches.length === 1) {
                x = evt.touches[0].clientX;
                y = evt.touches[0].clientY;
                return {
                    x: (x - rect.left > 0) ? x - rect.left : x,
                    y: (y - rect.top > 0) ? y - rect.top : y
                };
            } else {
                return {};
            }

        }
        var bindCanvasEvents = function (canvas) {
            canvas.addEventListener('touchstart', function (evt) {
                var mousePos = getMousePos(canvas, evt);
                console.log('touch Start ', mousePos);
            }, false);

            canvas.addEventListener('touchmove', function (evt) {
                var mousePos = getMousePos(canvas, evt);
                console.log('Touch move: ', mousePos);
            }, false);
        };
        var loadHomeImage = function () {
            return new Promise((res, rej) => {
                let img = $('.upload-image-elem');
                if (img) {
                    var hCanvas = document.createElement('CANVAS');
                    hCanvas.width = parseInt(getComputedStyle(img, false).width);
                    hCanvas.height = parseInt(getComputedStyle(img, false).height);

                    let hCtx = hCanvas.getContext('2d');
                    canvasConfig.hCtx = hCtx;
                    hCtx.clearRect(0, 0, hCanvas.width, hCanvas.height);
                    hCtx.drawImage(img, 0, 0, hCanvas.width, hCanvas.height);
                    hCanvas.classList = 'canvas-home';
                    if ($('.photo-holder canvas')) {
                        $('.photo-holder canvas').remove();
                    }
                    img.style.display = 'none';
                    $('.photo-holder').append(hCanvas);
                    bindCanvasEvents(hCanvas);
                    createSVG(hCanvas.width, hCanvas.height);
                }
                res({});
            });

        };

        var loadPoint = function (ctx) {
            // ctx.strokeStyle = '#131313';
            // ctx.lineWidth = 8;
            // ctx.arc(50, 50, 15, 0, 2 * Math.PI);
            // ctx.stroke();
            // ctx.fillStyle = "#f1f1f1";
            // ctx.fill();
        };

        var renderCanvas = function () {
            loadHomeImage().then(() => {
                loadPoint(canvasConfig.hCtx);
                setLoader(true);
            });
        };
    </script>
    <script>
        function loadImageToElem({
            src,
            e
        }) {
            var img = new Image();
            img.onload = function () {
                if (window.innerWidth > window.innerHeight) {
                    img.width = window.innerHeight;
                } else {
                    img.width = window.innerWidth;
                }
                if ($('.upload-image-elem')) {
                    $('.upload-image-elem').remove();
                }
                $('.photo-holder').append(img);
                renderCanvas();
                if (e) {
                    e.target.value = null;
                }
            };
            img.classList = 'upload-image-elem';
            img.src = src || canvasConfig.imgSrc;
        }

        function handleImage(e) {
            setLoader();
            var reader = new FileReader();
            reader.onload = function (event) {
                canvasConfig.imgSrc = event.target['result'];
                loadImageToElem({
                    e
                });
            };
            reader.readAsDataURL(e.target.files[0]);
        }
        canvasConfig.imgSrc = '/Allen Residence.jpg';
        loadImageToElem({
            src: '/Allen Residence.jpg'
        });
    </script>
</body>

</html>