<html>

<head>
    <title>Canvas Image Editor</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0, maximum-scale=1, minimum-scale=1">
    <link rel="stylesheet" type="text/css" href="styles.css" />
</head>

<body>
    <div>
        <input onchange="handleImage(event)" type="file" class="ptn-abs gallery" accept="image/*">
    </div>
    <div class="photo-holder">

    </div>

    <script>
        var $ = function(selector) {
            return document.querySelector(selector);
        };

        var getNewElement = function(elemName) {
            return document.createElement(elemName);
        };

        var setStyles = function(elem, styles) {
            Object.keys(styles).forEach(function(key) {
                elem.style[key] = styles[key];
            });
        };
    </script>
    <script>
        var canvasConfig = {
            imgSrc: null,
            doors: [],
            canvasDimensions: {
                width: 100,
                height: 100
            },
            canvasCtx: null,
            pointConfig: {
                width: 35
            }
        };
    </script>
    <script>
        var renderPoint = function(elem, opts) {
            var point = getNewElement('DIV');
            point.classList = 'drag-point';
            point.setAttribute('point-order', opts.order);
            point.setAttribute('point-type', opts.type);
            setStyles(point, {
                width: canvasConfig.pointConfig.width,
                height: canvasConfig.pointConfig.width,
                backgroundColor: '#f1f1f1',
                position: 'absolute',
                left: opts.x,
                top: opts.y,
                borderRadius: '25px',
                border: '4px solid black',
                opacity: '0.7'
            });
            point.addEventListener('touchmove', function(evt) {
                if (evt.touches.length === 1) {
                    var rect = elem.getBoundingClientRect();
                    var mX = evt.touches[0].clientX,
                        mY = evt.touches[0].clientY;
                    setStyles(point, {
                        left: mX - rect.left - (canvasConfig.pointConfig.width / 2),
                        top: mY - rect.top - (canvasConfig.pointConfig.width / 2)
                    });
                    reDrawCanvas();
                }
                if (evt.preventDefault) {
                    evt.preventDefault();
                }
                if (evt.stopPropagation) {
                    evt.stopPropagation();
                }
            }, false);
            elem.append(point);
        };

        var renderPoints = (elem) => {
            renderPoint(elem, {
                x: 100,
                y: 100,
                order: 1,
                type: 2
            });
            renderPoint(elem, {
                x: 150,
                y: 50,
                order: 2,
                type: 2
            });
            renderPoint(elem, {
                x: 200,
                y: 100,
                order: 3,
                type: 2
            });
            renderPoint(elem, {
                x: 200,
                y: 200,
                order: 4,
                type: 2
            });
            renderPoint(elem, {
                x: 100,
                y: 200,
                order: 5,
                type: 2
            });
        }

        var createSVG = function(w, h) {
            return new Promise((res, rej) => {
                var $div = getNewElement('DIV');
                $div.classList = 'canvas-mask'
                $div.style.width = w;
                $div.style.height = h;
                $div.style.backgroundColor = 'red';

                setStyles($div, {
                    width: w,
                    height: h,
                    backgroundColor: 'transparent',
                    position: 'absolute',
                    top: 0,
                    left: 0
                });

                $div.addEventListener('touchstart', function(evt) {
                    if (evt.touches.length === 1) {
                        console.log('holder : ', evt.touches[0].clientX, evt.touches[0].clientY);
                    }
                }, false);
                renderPoints($div);
                if ($('.canvas-mask')) {
                    $('.canvas-mask').remove();
                }
                $('.photo-holder').append($div);

                res({});
            });


        };
    </script>
    <script>
        var setLoader = function(isRemove) {
            if (isRemove) {
                if ($('.loader')) {
                    $('.loader').remove();
                }
            } else {
                var loaderElem = document.createElement('DIV');
                loaderElem.classList = 'loader';
                $('body').append(loaderElem);
            }
        };

        function getMousePos(canvas, evt) {
            var rect = canvas.getBoundingClientRect();
            let x = 0,
                y = 0;
            if (evt.touches.length === 1) {
                x = evt.touches[0].clientX;
                y = evt.touches[0].clientY;
                return {
                    x: (x - rect.left > 0) ? x - rect.left : x,
                    y: (y - rect.top > 0) ? y - rect.top : y
                };
            } else {
                return {};
            }

        }
        var bindCanvasEvents = function(canvas) {
            canvas.addEventListener('touchstart', function(evt) {
                var mousePos = getMousePos(canvas, evt);
                console.log('touch Start ', mousePos);
            }, false);

            canvas.addEventListener('touchmove', function(evt) {
                var mousePos = getMousePos(canvas, evt);
                console.log('Touch move: ', mousePos);
            }, false);
        };

        var canvasState = {
            img: null,
            width: 0,
            height: 0,
            ctx: null
        };
        var loadHomeImage = function() {
            return new Promise((res, rej) => {
                let img = $('.upload-image-elem');
                if (img) {
                    var hCanvas = document.createElement('CANVAS');
                    hCanvas.width = parseInt(getComputedStyle(img, false).width);
                    hCanvas.height = parseInt(getComputedStyle(img, false).height);

                    let hCtx = hCanvas.getContext('2d');
                    canvasConfig.hCtx = hCtx;

                    canvasState.ctx = hCtx;
                    canvasState.width = hCanvas.width;
                    canvasState.height = hCanvas.height;
                    canvasState.img = img;

                    hCtx.clearRect(0, 0, hCanvas.width, hCanvas.height);
                    //hCtx.drawImage(img, 0, 0, hCanvas.width, hCanvas.height);
                    hCanvas.classList = 'canvas-home';
                    if ($('.photo-holder canvas')) {
                        $('.photo-holder canvas').remove();
                    }
                    img.style.display = 'none';
                    $('.photo-holder').append(hCanvas);
                    bindCanvasEvents(hCanvas);
                    createSVG(hCanvas.width, hCanvas.height).then(() => {
                        res({});
                    })
                } else {
                    res({});
                }
            });

        };

        var reDrawCanvas = function() {
            canvasState.ctx.clearRect(0, 0, canvasState.width, canvasState.height);
            canvasState.ctx.drawImage(canvasState.img, 0, 0, canvasState.width, canvasState.height);
           
            drawDoorHolder(canvasState.ctx);
        };

        var drawDoorHolder = function(ctx) {
            var points = [];
            document.querySelectorAll('.drag-point').forEach((p) => {
                var style = getComputedStyle(p, false);
                points.push({
                    left: parseInt(style.left) + (canvasConfig.pointConfig.width / 2),
                    top: parseInt(style.top) + (canvasConfig.pointConfig.width / 2),
                    order: parseInt(p.getAttribute('point-order')),
                    type: parseInt(p.getAttribute('point-type'))
                });
            });
            if (points) {
                ctx.beginPath();
                points.forEach((p, index) => {
                    if (parseInt(p.order) === 1) {
                        ctx.moveTo(p.left, p.top);
                    } else {
                        if (p.type === 2 && (parseInt(p.order) === 2 || parseInt(p.order) === 3)) {
                            if (parseInt(p.order) === 2) {
                                ctx.quadraticCurveTo(p.left, p.top - 15, points[index + 1].left, points[index + 1].top);
                            }
                        } else {
                            ctx.lineTo(p.left, p.top);
                        }
                    }
                });
                ctx.closePath();
                ctx.lineWidth = 5;
                ctx.stroke();

                ctx.fillStyle = '#cecece';
                ctx.fill();
            }
        };

        var renderCanvas = function() {
            loadHomeImage().then(() => {
                drawDoorHolder(canvasConfig.hCtx);
                setLoader(true);
            });
        };
    </script>
    <script>
        function loadImageToElem({
            src,
            e
        }) {
            var img = new Image();
            img.onload = function() {
                if (window.innerWidth > window.innerHeight) {
                    img.width = window.innerHeight;
                } else {
                    img.width = window.innerWidth;
                }
                if ($('.upload-image-elem')) {
                    $('.upload-image-elem').remove();
                }
                $('.photo-holder').append(img);
                renderCanvas();
                if (e) {
                    e.target.value = null;
                }
            };
            img.classList = 'upload-image-elem';
            img.src = src || canvasConfig.imgSrc;
        }

        function handleImage(e) {
            setLoader();
            var reader = new FileReader();
            reader.onload = function(event) {
                canvasConfig.imgSrc = event.target['result'];
                loadImageToElem({
                    e
                });
            };
            reader.readAsDataURL(e.target.files[0]);
        }
        canvasConfig.imgSrc = '/Allen Residence.jpg';
        loadImageToElem({
            src: '/Allen Residence.jpg'
        });
    </script>
</body>

</html>